<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kulineria Smanida (Supabase DB)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@800&family=Pacifico&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #FEF2F2; } /* red-50 */
        .font-title { font-family: 'Poppins', sans-serif; }
        .font-subtitle { font-family: 'Pacifico', cursive; }
        .modal { background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); }
        .card { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06); }
        .shake { animation: shake 0.5s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); } 20%, 40%, 60%, 80% { transform: translateX(5px); } }
        .star-rating { display: flex; flex-direction: row-reverse; justify-content: flex-start; }
        .star-rating input { display: none; }
        .star-rating label { font-size: 24px; color: #ccc; cursor: pointer; transition: color 0.2s; }
        .star-rating input:checked ~ label, .star-rating label:hover, .star-rating label:hover ~ label { color: #facc15; }
        .food-icon {
            position: absolute;
            opacity: 0.15;
            pointer-events: none;
            z-index: 1;
        }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex justify-center items-center z-50 hidden">
        <div class="flex flex-col items-center p-6 bg-white rounded-xl shadow-2xl">
            <svg class="animate-spin h-8 w-8 text-red-600 mb-3" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <span class="text-gray-700 font-medium">Memproses...</span>
        </div>
    </div>

    <!-- 1. Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4 bg-red-50 relative overflow-hidden">
        <!-- Hiasan Makanan di Latar Belakang -->
        <!--  -->
        <svg class="food-icon w-32 h-32 text-red-200 top-10 left-10 transform -rotate-12" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C11.17 2 10.5 2.67 10.5 3.5V6H4.5C3.67 6 3 6.67 3 7.5V10.5C3 11.33 3.67 12 4.5 12H19.5C20.33 12 21 11.33 21 10.5V7.5C21 6.67 20.33 6 19.5 6H13.5V3.5C13.5 2.67 12.83 2 12 2ZM5 14C4.45 14 4 14.45 4 15V21H6V15C6 14.45 5.55 14 5 14ZM9 14C8.45 14 8 14.45 8 15V21H10V15C10 14.45 9.55 14 9 14ZM12 14C11.45 14 11 14.45 11 15V21H13V15C13 14.45 12.55 14 12 14ZM15 14C14.45 14 14 14.45 14 15V21H16V15C16 14.45 15.55 14 15 14ZM19 14C18.45 14 18 14.45 18 15V21H20V15C20 14.45 19.55 14 19 14Z" /></svg>
        <svg class="food-icon w-24 h-24 text-amber-200 bottom-16 right-12 transform rotate-12" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19.78 11.78L18.36 10.36L19.78 8.95C20.56 8.17 20.56 6.9 19.78 6.12L17.88 4.22C17.1 3.44 15.83 3.44 15.05 4.22L13.64 5.64L15.05 7.05L16.46 5.64L17.17 6.34L15.76 7.76L17.17 9.17L18.59 7.76L19.29 8.46L17.88 9.88L19.29 11.29L20.71 9.88L21.41 10.59L20 12L18.59 10.59L17.17 12L15.76 10.59L14.34 12L12.93 10.59L11.5 12L10.09 10.59L8.68 12L7.27 10.59L5.86 12L4.45 10.59L3.03 12L1.62 10.59L4.45 7.76L3.03 6.34L2.33 7.05L3.74 8.46L2.33 9.88L3.74 11.29L5.16 9.88L5.86 10.59L7.27 9.17L5.86 7.76L7.27 6.34L8.68 7.76L10.09 6.34L11.5 7.76L12.91 6.34L14.33 7.76L15.74 6.34L14.33 4.93L15.03 4.22L16.45 5.64L17.86 4.22L18.57 4.93L17.15 6.34L18.57 7.76L20 6.34L20.71 7.05L19.29 8.46L20.71 9.88L22.12 8.46C22.9 7.68 22.9 6.41 22.12 5.64L20.22 3.73C19.44 2.95 18.17 2.95 17.39 3.73L16 5.12V4C16 3.45 15.55 3 15 3H8C7.45 3 7 3.45 7 4V13.27L2.73 17.54C2.15 18.12 2.15 19.07 2.73 19.65L3.09 20.01C3.67 20.59 4.62 20.59 5.2 20.01L9.47 15.74H18C18.55 15.74 19 15.29 19 14.74V13H19.78C20.56 13 21.18 12.38 21.18 11.6C21.18 11.23 21.01 10.88 20.73 10.6L19.78 11.78Z"/></svg>

        <div class="w-full max-w-sm p-8 bg-white rounded-2xl shadow-xl z-10 text-center">
             <!-- Ikon Utama -->
             <div class="flex justify-center items-center mb-4">
                 <svg class="w-16 h-16 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.362 5.214A8.252 8.252 0 0112 21 8.25 8.25 0 016.038 7.048 8.287 8.287 0 009 9.6a8.983 8.983 0 013.362-3.797z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.362 5.214C15.63 5.372 15.89 5.544 16.138 5.728 17.935 7.166 19.5 9.358 19.5 12a8.25 8.25 0 01-5.962 7.952 8.257 8.257 0 01-1.28-1.427z" />
                 </svg>
            </div>
            
            <h2 class="text-4xl font-extrabold text-gray-900 font-title">Kulineria Smanida</h2>
            <p class="text-2xl text-orange-500 mt-2 mb-8 font-subtitle">Jajanan favorit, tinggal klik!</p>
            
            <form id="login-form" class="space-y-4">
                <input type="text" id="username-input" placeholder="Username" required class="w-full p-3 border border-gray-300 rounded-xl focus:ring-red-500 focus:border-red-500">
                <input type="password" id="password-input" placeholder="Password" required class="w-full p-3 border border-gray-300 rounded-xl focus:ring-red-500 focus:border-red-500">
                
                <p id="login-error" class="text-red-600 text-sm hidden">Login gagal. Cek username dan password.</p>
                
                <button type="submit" class="w-full py-3 bg-red-600 text-white font-bold rounded-xl hover:bg-red-700 transition duration-150 shadow-md">
                    Masuk
                </button>
            </form>
        </div>
    </div>

    <!-- 2. Main App Container (Hidden until login) -->
    <div id="app-container" class="min-h-screen hidden">
        <!-- Header -->
        <header class="bg-white shadow-lg sticky top-0 z-10">
            <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Kulineria Smanida</h1>
                    <p id="header-subtitle" class="text-sm text-gray-500 mt-1"></p>
                </div>

                <div class="flex items-center space-x-3">
                    <button id="dashboard-btn" class="hidden py-2 px-4 text-sm font-semibold rounded-lg bg-orange-800 text-white hover:bg-orange-900 transition shadow-md">
                        Dashboard
                    </button>
                    
                    <div id="seller-controls" class="flex space-x-2 hidden">
                        <button id="add-menu-btn" class="py-2 px-4 text-sm font-semibold rounded-lg bg-green-500 text-white hover:bg-green-600 transition shadow-md">
                            + Tambah Menu
                        </button>
                    </div>

                    <!-- Cart Icon -->
                    <div id="cart-icon-wrapper" class="relative cursor-pointer hidden">
                        <svg class="w-8 h-8 text-red-600" fill="currentColor" viewBox="0 0 20 20"><path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"/></svg>
                        <span id="cart-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full transform scale-0 origin-top-right">0</span>
                    </div>

                    <button id="logout-btn" class="py-2 px-4 text-sm font-semibold rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 transition shadow-sm">
                        Keluar
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8">
            <h2 id="menu-title" class="text-3xl font-extrabold text-gray-900 mb-6">Menu Hari Ini</h2>
            <div id="menu-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- Menu items rendered by JS -->
            </div>
        </main>
    </div>

    <!-- Modals are placed here -->
    <div id="all-modals-container">
        <!-- Modal Keranjang -->
        <div id="cart-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-40 p-4">
            <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl p-6 relative">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">Keranjang Belanja</h3>
                <button class="close-modal-btn absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-3xl font-light">&times;</button>
                <div id="cart-items-container" class="max-h-80 overflow-y-auto pr-2"></div>
                <p id="empty-cart-message" class="text-center text-gray-500 py-6">Keranjang Anda kosong.</p>
                <div id="cart-summary" class="mt-6 pt-4 border-t border-gray-200">
                    <div class="flex justify-between items-center font-bold text-xl mb-4">
                        <span>Total:</span>
                        <span id="cart-total" class="text-red-600">Rp 0</span>
                    </div>
                    <button id="checkout-btn" class="w-full py-3 bg-red-600 text-white font-bold rounded-xl hover:bg-red-700 transition" disabled>Lanjutkan Pembayaran</button>
                </div>
            </div>
        </div>

        <!-- Modal Form Menu -->
        <div id="menu-form-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-40 p-4">
             <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 relative">
                <h3 id="menu-form-title" class="text-2xl font-bold mb-6 text-gray-800">Tambah Menu Baru</h3>
                <button class="close-modal-btn absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-3xl font-light">&times;</button>
                <form id="menu-form" class="space-y-4">
                    <input type="hidden" id="menu-id">
                    <label class="block"><span class="text-gray-700">Nama Makanan</span><input type="text" id="menu-name" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg"></label>
                    <label class="block"><span class="text-gray-700">Harga (Rp)</span><input type="number" id="menu-price" required min="1000" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg"></label>
                    <label class="block"><span class="text-gray-700">URL Gambar</span><input type="url" id="menu-img" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg" value="https://placehold.co/300x200/fb923c/ffffff?text=Makanan"></label>
                    <button type="submit" class="w-full py-3 bg-red-600 text-white font-bold rounded-xl hover:bg-red-700 transition shadow-md">Simpan Menu</button>
                </form>
            </div>
        </div>
        
        <!-- Modal Form Pengguna (Admin) -->
        <div id="user-form-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-40 p-4">
             <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 relative">
                <h3 id="user-form-title" class="text-2xl font-bold mb-6 text-gray-800">Tambah Pengguna Baru</h3>
                <button class="close-modal-btn absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-3xl font-light">&times;</button>
                <form id="user-form" class="space-y-4">
                    <input type="hidden" id="original-username">
                    <label class="block">
                        <span class="text-gray-700">Username</span>
                        <input type="text" id="user-username" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg">
                    </label>
                    <label class="block">
                        <span class="text-gray-700">Password</span>
                        <input type="password" id="user-password" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg" placeholder="Masukkan password baru">
                    </label>
                    <label class="block">
                        <span class="text-gray-700">Role</span>
                        <select id="user-role" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg bg-white">
                            <option value="pembeli">Pembeli</option>
                            <option value="penjual">Penjual</option>
                        </select>
                    </label>
                    <label id="user-name-wrapper" class="block hidden">
                        <span class="text-gray-700">Nama Kantin</span>
                        <input type="text" id="user-name" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg">
                    </label>
                    <p class="text-xs text-gray-500">Password wajib diisi bahkan saat mengedit untuk konfirmasi.</p>
                    <button type="submit" class="w-full py-3 bg-red-600 text-white font-bold rounded-xl hover:bg-red-700 transition shadow-md">Simpan Pengguna</button>
                </form>
            </div>
        </div>

        <!-- Modal Konfirmasi -->
        <div id="confirm-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-40 p-4">
            <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-6 relative">
                <h3 id="confirm-modal-title" class="text-xl font-bold mb-4 text-gray-800">Konfirmasi Tindakan</h3>
                <p id="confirm-modal-text" class="mb-6 text-gray-600">Apakah Anda yakin?</p>
                <div class="flex justify-end space-x-3">
                    <button id="cancel-confirm-btn" class="py-2 px-4 rounded-lg text-gray-700 border border-gray-300 hover:bg-gray-100 transition">Batal</button>
                    <button id="confirm-action-btn" class="py-2 px-4 rounded-lg bg-red-500 text-white font-semibold hover:bg-red-600 transition">Ya, Lanjutkan</button>
                </div>
            </div>
        </div>
        
        <!-- Modal QRIS Payment -->
        <div id="qris-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-40 p-4">
             <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 relative text-center">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">Pembayaran QRIS</h3>
                <p class="text-gray-600 mb-6">Silakan scan kode di bawah. <span class="font-semibold">Ini adalah simulasi.</span></p>
                <img id="qris-image" src="" alt="QR Code Payment" class="w-60 h-60 mx-auto rounded-lg border-4 border-red-200 p-2 my-4">
                <div class="bg-red-50 p-4 rounded-xl mb-6">
                    <p class="text-sm text-gray-600">Nama Pembeli:</p>
                    <p id="qris-name" class="font-semibold text-lg text-orange-900 mb-2">Nama Siswa</p>
                    <p class="text-sm text-gray-600">Total Pembayaran:</p>
                    <p id="qris-total" class="font-bold text-2xl text-red-600">Rp 0</p>
                </div>
                <div class="flex justify-center space-x-3">
                    <button id="cancel-qris-btn" class="py-3 px-6 rounded-xl text-gray-700 border border-gray-300 hover:bg-gray-100 transition">Batal</button>
                    <button id="confirm-payment-btn" class="py-3 px-6 rounded-xl bg-green-500 text-white font-bold hover:bg-green-600 transition">Saya Sudah Bayar</button>
                </div>
            </div>
        </div>
        
        <!-- Modal Payment Success -->
        <div id="payment-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-40 p-4">
            <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 relative text-center">
                <svg class="w-16 h-16 text-green-500 mx-auto mb-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                <h3 class="text-2xl font-bold mb-2 text-gray-800">Pembayaran Berhasil!</h3>
                <p class="text-gray-600 mb-6">Pesanan Anda telah dikirim ke kantin.</p>
                <button id="close-payment-modal-btn" class="w-full py-3 bg-red-600 text-white font-bold rounded-xl hover:bg-red-700 transition shadow-md">Selesai & Beri Ulasan</button>
            </div>
        </div>

        <!-- Modal Rating & Review -->
        <div id="rating-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-40 p-4">
            <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl p-6 relative">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">Beri Ulasan Pesanan Anda</h3>
                <form id="rating-form" class="space-y-4">
                    <div id="rating-items-container" class="space-y-4 max-h-80 overflow-y-auto pr-2"></div>
                    <div class="flex justify-end space-x-3 pt-4 border-t border-gray-100">
                        <button type="button" id="skip-rating-btn" class="py-2 px-4 rounded-lg text-gray-700 border border-gray-300 hover:bg-gray-100 transition">Lewati</button>
                        <button type="submit" class="py-2 px-4 rounded-lg bg-red-500 text-white font-semibold hover:bg-red-600 transition">Kirim Ulasan</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal Admin Dashboard -->
        <div id="admin-dashboard-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-40 p-4">
             <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl p-6 relative">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-gray-800">Admin Dashboard: Kelola Pengguna</h3>
                    <button class="close-modal-btn text-gray-500 hover:text-gray-700 text-3xl font-light">&times;</button>
                </div>
                <button id="add-user-btn" class="mb-4 py-2 px-4 text-sm font-semibold rounded-lg bg-green-500 text-white hover:bg-green-600 transition shadow-md">+ Tambah Pengguna</button>
                <div class="space-y-3">
                    <div class="grid grid-cols-4 font-bold text-gray-700 border-b pb-2 gap-2"><span>Username</span><span>Role</span><span>Nama</span><span>Aksi</span></div>
                    <div id="user-list" class="space-y-2 max-h-96 overflow-y-auto"></div>
                </div>
            </div>
        </div>

        <!-- Modal Seller Dashboard -->
        <div id="seller-dashboard-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-40 p-4">
             <div class="bg-white w-full max-w-xl rounded-2xl shadow-2xl p-6 relative">
                <h3 id="seller-dashboard-title" class="text-2xl font-bold mb-4 text-gray-800">Dashboard Penjualan</h3>
                <button class="close-modal-btn absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-3xl font-light">&times;</button>
                <div class="bg-green-100 p-4 rounded-xl mb-6">
                    <p class="text-sm text-green-700">Total Penjualan Kotor:</p>
                    <p id="total-profit" class="font-bold text-3xl text-green-800">Rp 0</p>
                </div>
                <h4 class="text-xl font-semibold mb-3 border-b pb-1 text-gray-700">Daftar Penjualan</h4>
                <div id="sales-list" class="space-y-3 max-h-80 overflow-y-auto pr-2"></div>
            </div>
        </div>
    </div>

    <!-- Logic Script -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- KONFIGURASI SUPABASE ---
        const SUPABASE_URL = 'https://dmlfijjijvenbydpjeyb.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtbGZpamppanZlbmJ5ZHBqZXliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzOTUxNDQsImV4cCI6MjA3NTk3MTE0NH0.02BBhJ39t_LoXLKiQk45--5ul4duk-qbc2cGJ4Wp0aA';

        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- STATE APLIKASI ---
        let currentUser = null;
        let cart = {}; 
        let menu = [];
        let orders = [];
        let confirmCallback = () => {};
        let lastOrder = { items: [], studentName: '' };
        
        // --- DOM ELEMENTS ---
        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const loadingOverlay = document.getElementById('loading-overlay');
        const allModals = document.querySelectorAll('.modal');
        const menuList = document.getElementById('menu-list');
        const headerSubtitle = document.getElementById('header-subtitle');
        const menuTitle = document.getElementById('menu-title');
        const cartIconWrapper = document.getElementById('cart-icon-wrapper');
        const cartCount = document.getElementById('cart-count');
        const sellerControls = document.getElementById('seller-controls');
        const dashboardBtn = document.getElementById('dashboard-btn');
        const sellerDashboardModal = document.getElementById('seller-dashboard-modal');
        const adminDashboardModal = document.getElementById('admin-dashboard-modal');
        const userFormModal = document.getElementById('user-form-modal');
        const cartModal = document.getElementById('cart-modal');
        
        // --- FUNGSI UTILITAS ---
        const showLoading = () => loadingOverlay.classList.remove('hidden');
        const hideLoading = () => loadingOverlay.classList.add('hidden');
        const showModal = (modalEl) => modalEl.classList.remove('hidden');
        const hideModal = (modalEl) => modalEl.classList.add('hidden');
        const formatCurrency = (amount) => `Rp ${amount.toLocaleString('id-ID')}`;
        const showScreen = (screenName) => {
            loginScreen.classList.add('hidden');
            appContainer.classList.add('hidden');
            document.getElementById(screenName).classList.remove('hidden');
        };

        const calculateAverageRating = (ratings) => {
            const validRatings = Array.isArray(ratings) ? ratings : [];
            if (validRatings.length === 0) return { avg: 0, count: 0 };
            const total = validRatings.reduce((sum, r) => sum + (r.rating || 0), 0);
            return { avg: (total / validRatings.length).toFixed(1), count: validRatings.length };
        };

        const renderStars = (rating) => Array.from({length: 5}, (_, i) => `<svg class="w-4 h-4 ${i < rating ? 'text-amber-500' : 'text-gray-300'}" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>`).join('');

        // --- FUNGSI DATA (SUPABASE) ---
        async function fetchMenu() {
            const { data, error } = await db.from('menu').select('*').order('created_at');
            if (error) console.error('Error fetching menu:', error);
            else menu = data;
            renderMenu();
            updateCartSummary();
        }

        async function fetchOrders() {
            const { data, error } = await db.from('orders').select('*').order('created_at', { ascending: false });
            if (error) console.error('Error fetching orders:', error);
            else orders = data;
        }
        
        async function renderAdminDashboard() {
            showLoading();
            const { data: users, error } = await db.from('users').select('*').neq('role', 'admin').order('username');
            if (error) {
                console.error('Error fetching users:', error);
            } else {
                document.getElementById('user-list').innerHTML = users.map(user => `
                    <div class="grid grid-cols-4 items-center bg-white p-2 rounded text-sm gap-2">
                        <span>${user.username}</span>
                        <span class="capitalize">${user.role}</span>
                        <span>${user.name || '-'}</span>
                        <div class="flex gap-2">
                            <button class="edit-user-btn text-blue-600 hover:underline text-xs font-semibold" data-username="${user.username}">Edit</button>
                            <button class="delete-user-btn text-red-600 hover:underline text-xs font-semibold" data-username="${user.username}">Hapus</button>
                        </div>
                    </div>
                `).join('') || '<p class="text-gray-500 text-sm p-2">Belum ada pengguna.</p>';
            }
            hideLoading();
        }

        // --- FUNGSI LOGIN & SETUP UI ---
        const setupUIForRole = () => {
            dashboardBtn.classList.add('hidden');
            cartIconWrapper.classList.add('hidden');
            sellerControls.classList.add('hidden');
            
            if (currentUser.role === 'admin') {
                headerSubtitle.textContent = `Selamat datang, Admin!`;
                menuTitle.textContent = 'Semua Menu (Tampilan Admin)';
                dashboardBtn.textContent = 'Kelola Pengguna';
                dashboardBtn.classList.remove('hidden');
            } else if (currentUser.role === 'penjual') {
                headerSubtitle.textContent = `Selamat datang, ${currentUser.name}!`;
                menuTitle.textContent = 'Menu Anda';
                sellerControls.classList.remove('hidden');
                dashboardBtn.textContent = 'Dashboard Penjualan';
                dashboardBtn.classList.remove('hidden');
            } else if (currentUser.role === 'pembeli') {
                headerSubtitle.textContent = `Halo, ${currentUser.username}. Mau jajan apa hari ini?`;
                menuTitle.textContent = 'Menu Hari Ini';
                cartIconWrapper.classList.remove('hidden');
            }
            renderMenu();
            updateCartSummary();
        };

        const logout = () => {
            localStorage.removeItem(`kulineriaCart_${currentUser.username}`);
            currentUser = null;
            cart = {};
            showScreen('login-screen');
        };

        // --- FUNGSI RENDER ---
        const renderMenu = () => {
            if (!currentUser) return;
            let menuToRender = menu;
            if (currentUser.role === 'penjual') {
                menuToRender = menu.filter(item => item.seller === currentUser.name);
            }

            if (menuToRender.length === 0) {
                menuList.innerHTML = `<div class="col-span-full text-center p-8 bg-gray-50 rounded-lg"><p class="text-gray-500">${currentUser.role === 'pembeli' ? 'Menu belum tersedia.' : 'Anda belum punya menu.'}</p></div>`;
                return;
            }

            menuList.innerHTML = menuToRender.map(item => {
                const ratingInfo = calculateAverageRating(item.ratings);
                let buttonsHTML = '';

                if (currentUser.role === 'pembeli') {
                    buttonsHTML = `<button class="add-to-cart-btn w-full mt-auto py-2 px-4 rounded-lg font-semibold text-sm text-white bg-red-600 hover:bg-red-700 transition-all" data-id="${item.id}">+ Keranjang</button>`;
                } else if (currentUser.role === 'penjual' && item.seller === currentUser.name) {
                    buttonsHTML = `<div class="flex gap-2 mt-auto"><button class="edit-btn w-full py-2 px-4 rounded-lg font-semibold text-sm text-white bg-blue-500 hover:bg-blue-600" data-id="${item.id}">Edit</button><button class="delete-btn w-full py-2 px-4 rounded-lg font-semibold text-sm text-white bg-red-500 hover:bg-red-600" data-id="${item.id}">Hapus</button></div>`;
                }

                return `<div class="card rounded-2xl p-4 shadow-md flex flex-col bg-white transition-transform transform hover:-translate-y-1">
                    <img src="${item.img}" alt="${item.name}" class="rounded-lg mb-4 w-full h-40 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/300x200/ccc/ffffff?text=Error';">
                    <div class="flex flex-col flex-grow">
                        <p class="text-xs font-semibold text-orange-800">${item.seller}</p>
                        <h3 class="font-bold text-lg text-gray-800">${item.name}</h3>
                        <div class="flex items-center my-2 gap-1">${renderStars(ratingInfo.avg)} <span class="text-xs text-gray-500">(${ratingInfo.avg}/${ratingInfo.count})</span></div>
                        <p class="text-gray-600 mb-4 flex-grow font-semibold">${formatCurrency(item.price)}</p>
                        ${buttonsHTML}
                    </div>
                </div>`;
            }).join('');
        };
        
        const updateCartSummary = () => {
            let total = 0, itemCount = 0;
            for (const itemId in cart) {
                const menuItem = menu.find(m => m.id == itemId);
                if (menuItem) {
                    total += menuItem.price * cart[itemId].quantity;
                    itemCount += cart[itemId].quantity;
                }
            }
            document.getElementById('cart-total').textContent = formatCurrency(total);
            cartCount.textContent = itemCount;
            cartCount.classList.toggle('scale-0', itemCount === 0);
            cartCount.classList.toggle('scale-100', itemCount > 0);
            document.getElementById('checkout-btn').disabled = itemCount === 0;
            return total;
        };
        
        // --- EVENT LISTENERS ---

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();
            const username = document.getElementById('username-input').value;
            const password = document.getElementById('password-input').value;
            
            const { data, error } = await db.from('users').select('*').eq('username', username).single();

            if (error || data.password !== password) {
                document.getElementById('login-error').classList.remove('hidden');
                hideLoading();
            } else {
                document.getElementById('login-error').classList.add('hidden');
                currentUser = data;
                cart = JSON.parse(localStorage.getItem(`kulineriaCart_${currentUser.username}`)) || {};
                
                await fetchMenu();
                await fetchOrders();
                
                showScreen('app-container');
                setupUIForRole();
                hideLoading();
            }
        });
        
        document.getElementById('menu-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();
            const id = document.getElementById('menu-id').value;
            
            const menuData = {
                name: document.getElementById('menu-name').value,
                price: parseInt(document.getElementById('menu-price').value),
                img: document.getElementById('menu-img').value,
                seller: currentUser.name,
            };

            let result;
            if (id) {
                result = await db.from('menu').update(menuData).eq('id', id);
            } else {
                result = await db.from('menu').insert(menuData);
            }

            if (result.error) console.error('Error saving menu:', result.error);
            
            hideModal(document.getElementById('menu-form-modal'));
            hideLoading();
        });
        
        menuList.addEventListener('click', (e) => {
            const button = e.target.closest('[data-id]');
            if (!button) return;
            const id = button.dataset.id;
            
            if (button.classList.contains('add-to-cart-btn')) {
                cart[id] = cart[id] ? { quantity: cart[id].quantity + 1 } : { quantity: 1 };
                button.textContent = 'Ditambahkan ✓';
                setTimeout(() => { button.textContent = '+ Keranjang'; }, 1000);
                cartIconWrapper.classList.add('shake');
                setTimeout(() => cartIconWrapper.classList.remove('shake'), 500);
                localStorage.setItem(`kulineriaCart_${currentUser.username}`, JSON.stringify(cart));
                updateCartSummary();
            } else if (button.classList.contains('edit-btn')) {
                const item = menu.find(m => m.id == id);
                if (!item) return;
                document.getElementById('menu-form-title').textContent = 'Edit Menu';
                document.getElementById('menu-id').value = item.id;
                document.getElementById('menu-name').value = item.name;
                document.getElementById('menu-price').value = item.price;
                document.getElementById('menu-img').value = item.img;
                showModal(document.getElementById('menu-form-modal'));
            } else if (button.classList.contains('delete-btn')) {
                const item = menu.find(m => m.id == id);
                const confirmModal = document.getElementById('confirm-modal');
                document.getElementById('confirm-modal-title').textContent = 'Konfirmasi Hapus';
                document.getElementById('confirm-modal-text').textContent = `Yakin ingin menghapus "${item.name}"?`;
                confirmCallback = async () => {
                    showLoading();
                    await db.from('menu').delete().eq('id', id);
                    hideLoading();
                };
                showModal(confirmModal);
            }
        });
        
        document.getElementById('confirm-payment-btn').addEventListener('click', async () => {
            hideModal(document.getElementById('qris-modal'));
            showLoading();

            lastOrder.items = Object.keys(cart).map(id => {
                const menuItem = menu.find(m => m.id == id);
                return { ...menuItem, quantity: cart[id].quantity };
            });
            lastOrder.studentName = currentUser.username;
            
            const { error } = await db.from('orders').insert({
                buyer: currentUser.username,
                items: lastOrder.items
            });

            if(error) console.error("Gagal menyimpan pesanan", error);
            else {
                cart = {};
                localStorage.removeItem(`kulineriaCart_${currentUser.username}`);
                updateCartSummary();
                showModal(document.getElementById('payment-modal'));
            }
            hideLoading();
        });

        document.getElementById('rating-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();
            const ratingModal = document.getElementById('rating-modal');

            for (const item of lastOrder.items) {
                const ratingInput = ratingModal.querySelector(`input[name="rating-${item.id}"]:checked`);
                if (ratingInput) {
                    const reviewText = ratingModal.querySelector(`.review-text[data-id="${item.id}"]`).value;
                    const newRating = { 
                        rating: parseInt(ratingInput.value), 
                        review: reviewText, 
                        name: lastOrder.studentName,
                        date: new Date().toISOString()
                    };
                    const existingRatings = item.ratings || [];
                    await db.from('menu').update({ ratings: [...existingRatings, newRating] }).eq('id', item.id);
                }
            }
            
            hideLoading();
            hideModal(ratingModal);
        });
        
        document.getElementById('user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();
            const originalUsername = document.getElementById('original-username').value;
            
            const userData = {
                username: document.getElementById('user-username').value,
                password: document.getElementById('user-password').value,
                role: document.getElementById('user-role').value,
                name: document.getElementById('user-role').value === 'penjual' ? document.getElementById('user-name').value : null,
            };
            
            if (!userData.password) {
                alert('Password wajib diisi!');
                hideLoading();
                return;
            }

            let result;
            if (originalUsername) {
                result = await db.from('users').update({
                    password: userData.password,
                    role: userData.role,
                    name: userData.name
                }).eq('username', originalUsername);
            } else {
                result = await db.from('users').insert(userData);
            }

            if (result.error) {
                alert('Gagal menyimpan pengguna: ' + result.error.message);
            }

            hideModal(userFormModal);
            hideLoading();
        });

        document.getElementById('user-role').addEventListener('change', (e) => {
            document.getElementById('user-name-wrapper').classList.toggle('hidden', e.target.value !== 'penjual');
        });
        
        // Event listeners untuk tombol-tombol lain dan modal
        document.getElementById('logout-btn').addEventListener('click', logout);
        document.getElementById('add-menu-btn').addEventListener('click', () => {
             document.getElementById('menu-form').reset();
             document.getElementById('menu-form-title').textContent = 'Tambah Menu Baru';
             document.getElementById('menu-id').value = '';
             showModal(document.getElementById('menu-form-modal'));
        });
        
        dashboardBtn.addEventListener('click', async () => {
            if(currentUser.role === 'admin') {
                await renderAdminDashboard();
                showModal(adminDashboardModal);
            }
            if(currentUser.role === 'penjual') {
                 showLoading();
                 await fetchOrders();
                 const sellerOrders = orders.flatMap(order => (order.items || []).filter(item => item.seller === currentUser.name).map(item => ({ ...item, buyer: order.buyer, date: new Date(order.created_at).toLocaleString('id-ID') })));
                 document.getElementById('seller-dashboard-title').textContent = `Dashboard Penjualan (${currentUser.name})`;
                 document.getElementById('total-profit').textContent = formatCurrency(sellerOrders.reduce((sum, item) => sum + item.price * item.quantity, 0));
                 document.getElementById('sales-list').innerHTML = sellerOrders.length ? sellerOrders.map(item => `<div class="bg-gray-100 p-3 rounded-lg"><div class="flex justify-between font-semibold"><span>${item.name} (x${item.quantity})</span><span>${formatCurrency(item.price * item.quantity)}</span></div><div class="text-sm text-gray-500">Dipesan oleh: ${item.buyer}</div></div>`).join('') : '<p class="text-gray-500">Belum ada penjualan.</p>';
                 hideLoading();
                 showModal(sellerDashboardModal);
            }
        });
        
        adminDashboardModal.addEventListener('click', async (e) => {
            const button = e.target;
            const username = button.dataset.username;

            if (button.id === 'add-user-btn') {
                const form = document.getElementById('user-form');
                form.reset();
                document.getElementById('user-form-title').textContent = 'Tambah Pengguna Baru';
                document.getElementById('original-username').value = '';
                document.getElementById('user-username').disabled = false;
                document.getElementById('user-name-wrapper').classList.add('hidden');
                showModal(userFormModal);
            } else if (username) {
                if (button.classList.contains('delete-user-btn')) {
                    const confirmModal = document.getElementById('confirm-modal');
                    document.getElementById('confirm-modal-title').textContent = 'Konfirmasi Hapus';
                    document.getElementById('confirm-modal-text').textContent = `Yakin ingin menghapus pengguna "${username}"?`;
                    confirmCallback = async () => {
                        showLoading();
                        await db.from('users').delete().eq('username', username);
                        hideLoading();
                    };
                    showModal(confirmModal);
                } else if (button.classList.contains('edit-user-btn')) {
                    const { data: user } = await db.from('users').select('*').eq('username', username).single();
                    if (user) {
                        document.getElementById('user-form-title').textContent = 'Edit Pengguna';
                        document.getElementById('original-username').value = user.username;
                        const usernameInput = document.getElementById('user-username');
                        usernameInput.value = user.username;
                        usernameInput.disabled = true;
                        document.getElementById('user-password').value = ''; // Password should be re-entered
                        document.getElementById('user-role').value = user.role;
                        const nameWrapper = document.getElementById('user-name-wrapper');
                        const nameInput = document.getElementById('user-name');
                        if(user.role === 'penjual') {
                            nameInput.value = user.name;
                            nameWrapper.classList.remove('hidden');
                        } else {
                            nameInput.value = '';
                            nameWrapper.classList.add('hidden');
                        }
                        showModal(userFormModal);
                    }
                }
            }
        });

        cartIconWrapper.addEventListener('click', () => {
             const itemsHtml = Object.keys(cart).map(itemId => { 
                const menuItem = menu.find(m => m.id == itemId); 
                if (!menuItem) return ''; 
                return `<div class="flex justify-between items-center mb-4 p-3 rounded-lg bg-gray-100">
                    <div class="flex items-center gap-3"><img src="${menuItem.img}" class="w-12 h-12 object-cover rounded-md"/><div><h4 class="font-semibold">${menuItem.name}</h4><p class="text-sm text-gray-500">${formatCurrency(menuItem.price)}</p></div></div>
                    <div class="flex items-center gap-3"><button class="update-quantity-btn" data-id="${itemId}" data-action="minus">-</button><span>${cart[itemId].quantity}</span><button class="update-quantity-btn" data-id="${itemId}" data-action="plus">+</button><button class="remove-item-btn ml-2 text-red-500 font-bold" data-id="${itemId}">&times;</button></div>
                </div>`;
            }).join('');
            document.getElementById('cart-items-container').innerHTML = itemsHtml;
            document.getElementById('empty-cart-message').classList.toggle('hidden', !!itemsHtml);
            document.getElementById('cart-summary').classList.toggle('hidden', !itemsHtml);
            showModal(cartModal);
        });

        document.getElementById('cart-items-container').addEventListener('click', e => {
            const button = e.target.closest('button');
            if(!button) return;
            const id = button.dataset.id;
            const action = button.dataset.action;

            if (button.classList.contains('update-quantity-btn')) {
                if (action === 'plus') cart[id].quantity++;
                else if (action === 'minus' && cart[id].quantity > 1) cart[id].quantity--;
                else delete cart[id];
            } else if (button.classList.contains('remove-item-btn')) {
                delete cart[id];
            }
            localStorage.setItem(`kulineriaCart_${currentUser.username}`, JSON.stringify(cart));
            updateCartSummary();
            cartIconWrapper.click(); // re-render cart modal
        });

        document.getElementById('checkout-btn').addEventListener('click', () => {
            hideModal(cartModal);
            const total = updateCartSummary();
            const qrisModal = document.getElementById('qris-modal');
            qrisModal.querySelector('#qris-name').textContent = currentUser.username;
            qrisModal.querySelector('#qris-total').textContent = formatCurrency(total);
            const qrData = encodeURIComponent(`Pembayaran Kulineria Smanida\nNama: ${currentUser.username}\nTotal: ${total}`);
            qrisModal.querySelector('#qris-image').src = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${qrData}`;
            showModal(qrisModal);
        });

        document.getElementById('close-payment-modal-btn').addEventListener('click', () => {
            hideModal(document.getElementById('payment-modal'));
            if(lastOrder.items.length) {
                const ratingModal = document.getElementById('rating-modal');
                ratingModal.querySelector('#rating-items-container').innerHTML = lastOrder.items.map(item => `
                    <div class="p-3 bg-gray-100 rounded-lg">
                        <p class="font-semibold text-gray-800">${item.name}</p>
                        <div class="my-2"><div class="star-rating"><input type="radio" id="5-${item.id}" name="rating-${item.id}" value="5"/><label for="5-${item.id}">☆</label><input type="radio" id="4-${item.id}" name="rating-${item.id}" value="4"/><label for="4-${item.id}">☆</label><input type="radio" id="3-${item.id}" name="rating-${item.id}" value="3"/><label for="3-${item.id}">☆</label><input type="radio" id="2-${item.id}" name="rating-${item.id}" value="2"/><label for="2-${item.id}">☆</label><input type="radio" id="1-${item.id}" name="rating-${item.id}" value="1"/><label for="1-${item.id}">☆</label></div></div>
                        <textarea class="review-text w-full p-2 border rounded-md text-sm" data-id="${item.id}" placeholder="Tulis ulasan (opsional)"></textarea>
                    </div>`).join('');
                showModal(ratingModal);
            }
        });

        allModals.forEach(modal => {
            modal.addEventListener('click', e => {
                if (e.target.classList.contains('modal') || e.target.closest('.close-modal-btn')) hideModal(modal);
            });
        });
        document.getElementById('cancel-qris-btn').addEventListener('click', () => { hideModal(document.getElementById('qris-modal')); showModal(cartModal); });
        document.getElementById('skip-rating-btn').addEventListener('click', () => hideModal(document.getElementById('rating-modal')));
        document.getElementById('confirm-action-btn').addEventListener('click', () => { if(typeof confirmCallback === 'function') confirmCallback(); hideModal(document.getElementById('confirm-modal')); });
        document.getElementById('cancel-confirm-btn').addEventListener('click', () => hideModal(document.getElementById('confirm-modal')));

        // --- Inisialisasi & Langganan Realtime ---
        function initializeRealtime() {
            db.channel('public-menu-channel')
              .on('postgres_changes', { event: '*', schema: 'public', table: 'menu' }, () => fetchMenu())
              .subscribe();
              
            db.channel('public-orders-channel')
              .on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, () => {
                  fetchOrders().then(() => {
                      if (currentUser?.role === 'penjual' && !sellerDashboardModal.classList.contains('hidden')) {
                          dashboardBtn.click();
                      }
                  });
              })
              .subscribe();
              
            db.channel('public-users-channel')
              .on('postgres_changes', { event: '*', schema: 'public', table: 'users' }, () => {
                  if (currentUser?.role === 'admin' && !adminDashboardModal.classList.contains('hidden')) {
                      renderAdminDashboard();
                  }
              })
              .subscribe();
        }
        
        initializeRealtime();
    });
    </script>
</body>
</html>
